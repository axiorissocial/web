<VirtualHost *:80>
    ServerName axioris.omgrod.me
    DocumentRoot /var/www/axioris/dist

    <Directory /var/www/axioris/dist>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted

        # Enable rewrite engine for SPA routing
        RewriteEngine On
        RewriteBase /

        # Prevent rewriting for existing files and directories
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        
        # Don't rewrite API, uploads, or sitemap requests
        RewriteCond %{REQUEST_URI} !^/api/
        RewriteCond %{REQUEST_URI} !^/uploads/
        RewriteCond %{REQUEST_URI} !^/sitemap\.xml

        # Serve index.html for all other requests (SPA fallback)
        RewriteRule ^ /index.html [L]

        # Set correct MIME types
        AddType application/javascript .js .mjs
        AddType text/css .css
        AddType application/json .json
        AddType image/svg+xml .svg .svgz
        AddType image/webp .webp
        AddType font/woff .woff
        AddType font/woff2 .woff2
        AddType font/ttf .ttf
        AddType font/otf .otf

        # Enable compression
        <IfModule mod_deflate.c>
            AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json image/svg+xml
        </IfModule>

        # Cache static assets
        <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresByType application/javascript "access plus 1 year"
            ExpiresByType text/css "access plus 1 year"
            ExpiresByType image/svg+xml "access plus 1 year"
            ExpiresByType image/png "access plus 1 year"
            ExpiresByType image/jpeg "access plus 1 year"
            ExpiresByType image/webp "access plus 1 year"
            ExpiresByType font/woff "access plus 1 year"
            ExpiresByType font/woff2 "access plus 1 year"
            ExpiresByType font/ttf "access plus 1 year"
            ExpiresByType font/otf "access plus 1 year"
        </IfModule>

        # Security headers
        Header always set X-Content-Type-Options "nosniff"
        Header always set X-Frame-Options "SAMEORIGIN"
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Referrer-Policy "strict-origin-when-cross-origin"

        # Block access to hidden files and directories
        <FilesMatch "^\.">
            Require all denied
        </FilesMatch>

        # Block access to node_modules if accidentally in dist
        <DirectoryMatch "node_modules">
            Require all denied
        </DirectoryMatch>

        # Block source maps in production
        <FilesMatch "\.map$">
            Require all denied
        </FilesMatch>
    </Directory>

    # Proxy API requests to backend server
    # NOTE: These ProxyPass directives are processed BEFORE the Directory rewrite rules
    # This ensures API, uploads, and sitemap requests are proxied correctly
    <IfModule mod_proxy.c>
        ProxyPreserveHost On
        ProxyRequests Off

        # API proxy
        ProxyPass /api http://localhost:3001/api
        ProxyPassReverse /api http://localhost:3001/api

        # Uploads proxy
        ProxyPass /uploads http://localhost:3001/uploads
        ProxyPassReverse /uploads http://localhost:3001/uploads

        # Sitemap proxy
        ProxyPass /sitemap.xml http://localhost:3001/sitemap.xml
        ProxyPassReverse /sitemap.xml http://localhost:3001/sitemap.xml
    </IfModule>

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/axioris_error.log
    CustomLog ${APACHE_LOG_DIR}/axioris_access.log combined
</VirtualHost>

# SSL Configuration (uncomment and configure after obtaining SSL certificate)
# <VirtualHost *:443>
#     ServerName axioris.omgrod.me
#     DocumentRoot /var/www/axioris/dist
#
#     SSLEngine on
#     SSLCertificateFile /path/to/certificate.crt
#     SSLCertificateKeyFile /path/to/private.key
#     SSLCertificateChainFile /path/to/chain.crt
#
#     # Include the same configuration as port 80 above
#     # ...
# </VirtualHost>
